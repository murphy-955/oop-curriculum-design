# Redis 键值对说明文档

## 1. 键值设计概览

本系统使用 Redis 作为唯一的数据存储，主要用于存储比赛信息、比赛事件和支持实时直播功能。以下是系统中使用的 Redis 键值对详细说明。

## 2. 键的命名规范

- 键名采用冒号(`:`)分隔的层级结构
- 前缀用于区分不同类型的数据
- 后缀通常是唯一标识符（如 UUID）

## 3. 具体键值说明

### 3.1 比赛基本信息

| 键名格式 | 类型 | 说明 | 示例值 |
|---------|------|------|--------|
| `game:{gameId}` | Hash | 存储单个比赛的详细信息 | `{"uuid": "1234-5678", "title": "NBA总决赛", "description": "湖人队 vs 凯尔特人队", ...}` |
| `games:list` | Hash | 存储所有比赛的列表，用于快速查询 | `{"1234-5678": {"name": "NBA总决赛", "uuid": "1234-5678"}, ...}` |

### 3.2 比赛事件

| 键名格式 | 类型 | 说明 | 示例值 |
|---------|------|------|--------|
| `game:events:{gameId}` | List | 存储比赛的所有事件，按时间顺序排列 | `[{"team": "init", "members": [...], "action": "init", ...}, ...]` |

### 3.3 实时直播频道

| 键名格式 | 类型 | 说明 | 示例值 |
|---------|------|------|--------|
| `game:channel:{gameId}` | Pub/Sub Channel | 用于实时推送比赛事件的频道 | 无（用于发布订阅） |

## 4. 数据结构详解

### 4.1 比赛信息结构 (game:{gameId})

```json
{
  "uuid": "string",        // 比赛唯一标识符
  "title": "string",       // 比赛标题
  "description": "string", // 比赛描述
  "start_time": "string",  // 比赛开始时间
  "master": {
    "name": "string",      // 主队名称
    "logo": "string",      // 主队logo URL
    "members": [            // 主队队员列表
      {
        "name": "string",  // 队员姓名
        "position": "string" // 队员位置
      }
    ]
  },
  "guest": {
    "name": "string",      // 客队名称
    "logo": "string",      // 客队logo URL
    "members": [            // 客队队员列表
      {
        "name": "string",  // 队员姓名
        "position": "string" // 队员位置
      }
    ]
  },
  "masterScore": "integer", // 主队当前得分
  "guestScore": "integer"   // 客队当前得分
}
```

### 4.2 比赛事件结构 (game:events:{gameId} 列表项)

```json
{
  "team": "string",        // 事件所属队伍（"master"、"guest"或"init"）
  "members": ["string"],   // 参与事件的队员列表
  "action": "string",      // 事件类型（"跳球"、"盖帽"、"传球"、"得分"、"失误"等）
  "score": "integer",      // 当前队伍得分
  "time": "string"         // 事件发生时间
}
```

### 4.3 比赛列表项结构 (games:list 哈希值)

```json
{
  "name": "string",        // 比赛名称
  "uuid": "string"         // 比赛唯一标识符
}
```

## 5. Redis 命令使用场景

| 场景 | 使用的 Redis 命令 | 说明 |
|------|------------------|------|
| 创建比赛 | SET, HSET | 存储比赛信息，添加到比赛列表 |
| 同步比赛信息 | GET, SET, LPUSH, PUBLISH | 更新比赛信息，添加事件，推送实时通知 |
| 查询比赛列表 | HGETALL | 获取所有比赛的基本信息 |
| 观看比赛 | LRANGE, PUBLISH/SUBSCRIBE | 获取历史事件，订阅实时事件 |

## 6. 过期策略

- 比赛信息：长期存储，无过期时间
- 比赛事件：长期存储，无过期时间
- 发布订阅频道：无持久化，仅用于实时通信

## 7. 性能考虑

- 使用哈希表存储比赛列表，便于快速查询和更新
- 使用列表存储比赛事件，便于按时间顺序获取
- 发布订阅机制用于实时推送，避免频繁轮询
- 键名采用前缀区分，便于管理和查询

## 8. 数据备份与恢复

建议定期对 Redis 数据进行备份，可使用 Redis 的 `SAVE` 或 `BGSAVE` 命令生成 RDB 文件，或开启 AOF 持久化功能。

## 9. 注意事项

1. 比赛 ID 使用 UUID 生成，确保唯一性
2. 发布订阅频道名称与比赛 ID 绑定，确保频道唯一性
3. 比赛事件列表会随着比赛进行而增长，注意监控内存使用
4. JWT 令牌用于验证主持人身份，有效期为 24 小时

## 10. 未来扩展

- 可考虑为比赛信息添加过期时间，自动清理过期比赛
- 可添加更多比赛统计数据，如技术统计、球员数据等
- 可实现比赛事件的分页查询，优化大数据量下的查询性能
- 可添加 Redis 集群支持，提高系统可用性和扩展性