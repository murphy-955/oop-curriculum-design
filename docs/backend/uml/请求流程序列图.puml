@startuml
title 体育赛事直播可视化系统 - 完整请求处理流程

participant "用户客户端" as Client
participant "Nginx" as Nginx
participant "网关服务" as Gateway
participant "事件摄取服务" as EventIngest
participant "Kafka" as Kafka
participant "事件处理服务" as EventProcessor
participant "Redis集群" as Redis
participant "MySQL主库" as MySQL
participant "MySQL从库" as MySQLSlave
participant "比赛状态服务" as MatchState
participant "球员统计服务" as PlayerStats
participant "可视化引擎服务" as Visualization
participant "WebSocket广播服务" as WebSocket
participant "Nacos注册中心" as Nacos

box "微服务集群" #LightBlue
  participant Gateway
  participant EventIngest
  participant EventProcessor
  participant MatchState
  participant PlayerStats
  participant Visualization
  participant WebSocket
end box

box "基础设施" #LightGreen
  participant Nacos
  participant Kafka
  participant Redis
  participant MySQL
  participant MySQLSlave
end box

== 1. 服务注册与发现 ==

activate Nacos
Gateway -> Nacos: 1.1 注册服务实例
EventIngest -> Nacos: 1.2 注册服务实例
EventProcessor -> Nacos: 1.3 注册服务实例
MatchState -> Nacos: 1.4 注册服务实例
PlayerStats -> Nacos: 1.5 注册服务实例
Visualization -> Nacos: 1.6 注册服务实例
WebSocket -> Nacos: 1.7 注册服务实例

Gateway -> Nacos: 1.8 拉取服务列表
Nacos --> Gateway: 返回可用服务列表
deactivate Nacos

== 2. 事件数据摄取流程 ==

Client -> Nginx: 2.1 POST /api/events/stream\n上传比赛事件流
activate Nginx
Nginx -> Gateway: 2.2 转发请求到网关
activate Gateway

Gateway -> Nacos: 2.3 获取事件摄取服务地址
activate Nacos
Nacos --> Gateway: 返回EventIngest地址
deactivate Nacos

Gateway -> EventIngest: 2.4 负载均衡转发请求
activate EventIngest

EventIngest -> EventIngest: 2.5 验证数据格式\n解析事件流

group 异步处理事件流
  EventIngest -> Kafka: 2.6 发送原始事件到\ngame-events-raw主题
  activate Kafka
  Kafka --> EventIngest: 2.7 确认接收
  deactivate Kafka
end

EventIngest -> Gateway: 2.8 返回202 Accepted\n(事件已接收)
Gateway -> Nginx: 2.9 返回响应
Nginx -> Client: 2.10 返回成功响应
deactivate Nginx
deactivate Gateway
deactivate EventIngest

== 3. 事件处理与状态更新 ==

EventProcessor -> Kafka: 3.1 订阅game-events-raw主题\n(消费者组)
activate Kafka
Kafka --> EventProcessor: 3.2 推送事件数据
deactivate Kafka

activate EventProcessor
EventProcessor -> EventProcessor: 3.3 解析事件类型\n(2分球/3分球/犯规等)

alt 需要实时更新的数据
  EventProcessor -> MatchState: 3.4 RPC调用更新比赛状态
  activate MatchState

  MatchState -> Redis: 3.5 更新比赛状态缓存
  activate Redis
  Redis --> MatchState: 3.6 确认更新
  deactivate Redis

  MatchState -> MySQL: 3.7 异步持久化到数据库
  activate MySQL
  MySQL --> MatchState: 3.8 确认写入
  deactivate MySQL

  MatchState --> EventProcessor: 3.9 返回更新结果
  deactivate MatchState
end

alt 需要统计的数据
  EventProcessor -> PlayerStats: 3.10 RPC调用更新球员统计
  activate PlayerStats

  PlayerStats -> Redis: 3.11 更新球员统计缓存
  activate Redis
  Redis --> PlayerStats: 3.12 确认更新
  deactivate Redis

  PlayerStats -> MySQLSlave: 3.13 写入统计数据库(读写分离)
  activate MySQLSlave
  MySQLSlave --> PlayerStats: 3.14 确认写入
  deactivate MySQLSlave

  PlayerStats --> EventProcessor: 3.15 返回更新结果
  deactivate PlayerStats
end

EventProcessor -> Kafka: 3.16 发送处理后事件到\ngame-events-processed主题
activate Kafka
Kafka --> EventProcessor: 3.17 确认接收
deactivate Kafka

deactivate EventProcessor

== 4. 用户请求可视化数据 ==

Client -> Nginx: 4.1 GET /api/visualization/{matchId}
activate Nginx
Nginx -> Gateway: 4.2 转发请求到网关
activate Gateway

Gateway -> Nacos: 4.3 获取可视化服务地址
activate Nacos
Nacos --> Gateway: 返回Visualization地址
deactivate Nacos

Gateway -> Visualization: 4.4 负载均衡转发请求
activate Visualization

Visualization -> MatchState: 4.5 并发调用获取比赛状态
activate MatchState
Visualization -> PlayerStats: 4.6 并发调用获取球员统计
activate PlayerStats

MatchState -> Redis: 4.7 查询比赛状态缓存
activate Redis
alt 缓存命中
  Redis --> MatchState: 4.8 返回缓存数据
else 缓存未命中
  Redis --> MatchState: 4.9 返回空
  MatchState -> MySQL: 4.10 查询数据库
  activate MySQL
  MySQL --> MatchState: 4.11 返回数据
  deactivate MySQL
  MatchState -> Redis: 4.12 更新缓存
  Redis --> MatchState: 4.13 确认
end
deactivate Redis
MatchState --> Visualization: 4.14 返回比赛状态
deactivate MatchState

PlayerStats -> Redis: 4.15 查询球员统计缓存
activate Redis
alt 缓存命中
  Redis --> PlayerStats: 4.16 返回缓存数据
else 缓存未命中
  Redis --> PlayerStats: 4.17 返回空
  PlayerStats -> MySQLSlave: 4.18 查询从库
  activate MySQLSlave
  MySQLSlave --> PlayerStats: 4.19 返回统计
  deactivate MySQLSlave
  PlayerStats -> Redis: 4.20 更新缓存
  Redis --> PlayerStats: 4.21 确认
end
deactivate Redis
PlayerStats --> Visualization: 4.22 返回球员统计
deactivate PlayerStats

Visualization -> Visualization: 4.23 组装可视化数据\n(渲染球场、球员、动画)

Visualization --> Gateway: 4.24 返回可视化JSON数据
Gateway -> Nginx: 4.25 返回响应
Nginx -> Client: 4.26 返回可视化数据
deactivate Nginx
deactivate Gateway
deactivate Visualization

== 5. 实时WebSocket推送 ==

Client -> Nginx: 5.1 WebSocket连接 /ws/match/{matchId}
activate Nginx
Nginx -> Gateway: 5.2 升级协议WebSocket代理
activate Gateway

Gateway -> Nacos: 5.3 获取WebSocket服务地址
activate Nacos
Nacos --> Gateway: 返回WebSocket服务地址
deactivate Nacos

Gateway -> WebSocket: 5.4 转发WebSocket连接
activate WebSocket

WebSocket -> WebSocket: 5.5 创建会话\n加入房间{matchId}
WebSocket -> Redis: 5.6 订阅频道 match:{matchId}
activate Redis
Redis --> WebSocket: 5.7 订阅成功
deactivate Redis

WebSocket --> Gateway: 5.8 连接建立成功
Gateway --> Nginx: 5.9 WebSocket连接建立
Nginx --> Client: 5.10 WebSocket连接成功
deactivate Nginx
deactivate Gateway

== 6. 实时事件广播 ==

EventProcessor -> Kafka: 6.1 发送动画事件到\ngame-animations主题
activate Kafka
Kafka --> EventProcessor: 6.2 确认接收
deactivate Kafka

Note over Kafka,WebSocket: 消息驱动架构

WebSocket -> Kafka: 6.3 订阅game-animations主题\n(消费者组)
activate Kafka
Kafka --> WebSocket: 6.4 推送动画事件
deactivate Kafka

activate WebSocket
WebSocket -> WebSocket: 6.5 处理动画事件\n生成WebSocket消息

WebSocket -> Redis: 6.6 获取在线用户列表
activate Redis
Redis --> WebSocket: 6.7 返回房间{matchId}用户
deactivate Redis

loop 对房间内每个用户
  WebSocket -> Client: 6.8 推送实时更新\n(通过WebSocket)
end

WebSocket -> Redis: 6.9 更新事件缓存\n(供新用户同步)
activate Redis
Redis --> WebSocket: 6.10 确认
deactivate Redis
deactivate WebSocket

== 7. 监控与熔断 ==

Note over Gateway: 7.1 网关监控每个请求
Gateway -> Gateway: 7.2 记录指标: 响应时间、状态码

alt 服务调用超时
  Gateway -> Gateway: 7.3 触发熔断机制
  Gateway -> Client: 7.4 返回降级响应
end

Note over Visualization: 7.5 服务间熔断
Visualization -> Visualization: 7.6 当MatchState/PlayerStats\n失败时使用缓存数据

== 8. 数据库同步 ==

MySQL -> MySQLSlave: 8.1 主从数据同步
activate MySQLSlave
MySQLSlave --> MySQL: 8.2 同步确认
deactivate MySQLSlave

Note over Redis: 8.3 Redis集群数据分片
Redis -> Redis: 8.4 集群内数据同步

@enduml